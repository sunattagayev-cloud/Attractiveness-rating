<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standard and Sensitive Ratings Dashboard</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a0ca3;
            --orange: #f59e0b;
            --success: #10b981;
            --danger: #ef476f;
            --purple: #8b5cf6;
            --info: #06b6d4;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --border: #e5e7eb;
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        body.dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
            --primary: #6366f1;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            transition: all 0.3s ease;
        }

        /* Loading */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid var(--border);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Header */
        .glass-header {
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px);
            position: sticky; top: 0; z-index: 100;
            padding: 15px 0; border-bottom: 1px solid var(--border);
        }
        body.dark-mode .glass-header { background: rgba(30, 41, 59, 0.85); }

        .header-inner {
            max-width: 1400px; margin: 0 auto; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand-box h1 { margin: 0; font-size: 1.3rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .source-badge { font-size: 0.75rem; color: var(--text-secondary); display: block; margin-top: 4px; font-weight: 500;}
        .source-badge a { color: var(--primary); text-decoration: none; border-bottom: 1px dashed var(--primary); }

        .btn-icon {
            background: transparent; border: 1px solid var(--border); color: var(--text-main);
            width: 38px; height: 38px; border-radius: 10px; cursor: pointer; transition: 0.2s;
        }
        .btn-icon:hover { background: var(--border); color: var(--primary); }
        .active-lang { background: var(--primary) !important; color: white !important; border-color: var(--primary) !important; }

        /* Main Layout */
        .container {
            max-width: 1400px; margin: 30px auto; padding: 0 20px;
            display: grid; grid-template-columns: 320px 1fr; gap: 25px;
        }
        @media (max-width: 1024px) { .container { grid-template-columns: 1fr; } }

        /* Cards */
        .card {
            background: var(--bg-card); border-radius: var(--radius); padding: 20px;
            border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 20px;
        }
        .form-select, .form-input {
            width: 100%; padding: 10px; border-radius: 10px;
            border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main);
            margin-bottom: 15px; outline: none; box-sizing: border-box; font-family: 'Inter', sans-serif;
        }

        /* Sticky Sidebar for Alignment */
        aside {
            position: sticky;
            top: 90px;
            height: fit-content;
        }

        /* Calculator Styles */
        .calc-box {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.05), rgba(16, 185, 129, 0.05));
            border: 1px solid var(--border); padding: 15px; border-radius: 12px; margin-bottom: 20px;
        }
        .calc-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; align-items: center;}
        .calc-val { font-weight: bold; color: var(--text-main); text-align: right; }
        .calc-profit { color: var(--success); font-size: 1.2rem; font-weight: 700; display: block; text-align: right;}
        .calc-label { color: var(--text-secondary); }
        
        .input-group { position: relative; margin-bottom: 15px; }
        .input-currency {
            position: absolute; right: 10px; top: 10px; font-weight: bold; color: var(--primary); font-size: 0.9rem;
        }

        /* Promo / Info */
        .promo-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; text-align: center; position: relative; overflow: hidden; padding: 25px;
            margin-bottom: 0;
        }
        .promo-bg {
            position: absolute; width: 150px; height: 150px; background: rgba(255,255,255,0.1);
            border-radius: 50%; top: -50px; right: -50px;
        }
        .promo-logo {
            max-width: 180px; margin-bottom: 15px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
        }
        .slogan-animate { animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .social-links { display: flex; gap:10px; justify-content: center; margin-top:15px; }
        .social-links a { 
            color: white; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; 
            border: 1px solid rgba(255,255,255,0.3); padding: 10px 16px; border-radius: 10px; font-size: 0.9rem; transition: 0.2s; background: rgba(255,255,255,0.1);
        }
        .social-links a:hover { background: rgba(255,255,255,0.25); transform: translateY(-2px); }

        /* KPI */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 25px;
        }
        .stat-card {
            background: var(--bg-card); padding: 20px; border-radius: var(--radius);
            border: 1px solid var(--border); display: flex; align-items: flex-start; justify-content: space-between;
            box-shadow: var(--shadow); position: relative; overflow: hidden; min-height: 110px;
        }
        .stat-info { flex: 1; min-width: 0; } 
        .stat-icon {
            width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; margin-left: 10px; flex-shrink: 0;
        }
        .change-badge { 
            font-size: 0.8rem; background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 4px; margin-top: 5px; 
            font-weight: 600; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }

        /* Charts */
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px; transition: all 0.3s ease; }
        @media (max-width: 900px) { .charts-row { grid-template-columns: 1fr; } }
        .chart-box { height: 380px; position: relative; }

        /* Table */
        .table-container { overflow-x: auto; margin-top: 10px; border-radius: 12px; border: 1px solid var(--border); max-height: 700px; overflow-y: auto;}
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: center; border-bottom: 1px solid var(--border); white-space: nowrap; vertical-align: middle; }
        td:first-child, th:first-child { text-align: left; }
        th { background: var(--bg-body); font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); cursor: pointer; position: sticky; top: 0; z-index: 10;}
        th:hover { background: rgba(0,0,0,0.05); }
        
        /* Rating Colors */
        .rating-green { color: var(--success); font-weight: bold; } 
        .rating-blue { color: var(--primary); font-weight: bold; }
        .rating-yellow { color: var(--orange); font-weight: bold; }
        .rating-red { color: var(--danger); font-weight: bold; }
        
        .score-badge {
            padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 0.85rem; color: #fff;
        }

        .footer { text-align: center; padding: 20px; margin-top: 30px; color: var(--text-secondary); font-size: 0.85rem; border-top: 1px solid var(--border); }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        body.dark-mode ::-webkit-scrollbar-thumb { background: #475569; }
    </style>
</head>
<body>

    <!-- Loader -->
    <div class="loading-overlay" id="loader">
        <div class="spinner"></div>
        <p style="font-weight:500;">Ma'lumotlar yuklanmoqda...</p>
    </div>

    <!-- Header -->
    <header class="glass-header">
        <div class="header-inner">
            <div class="brand-box">
                <h1><i class="fa-solid fa-chart-line"></i> <span id="t-brand">Investitsion Tahlil</span></h1>
                <div>
                    <span class="source-badge">
                        <i class="fa-solid fa-layer-group"></i> <span id="t-subtitle">Qimmatli qog'ozlar jozibadorlik reytingi</span>
                    </span>
                    <span class="source-badge" style="font-size: 0.75rem; opacity: 0.8;">
                        <i class="fa-solid fa-link"></i> <span id="t-source">Manba: <a href="https://uzse.uz" target="_blank">uzse.uz</a> va <a href="https://new.openinfo.uz/" target="_blank">openinfo.uz</a> ma'lumotlari va Reyting Agentligi metodikasi asosida</span>
                    </span>
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn-icon" onclick="toggleTheme()" title="Mavzu"><i class="fa-solid fa-moon"></i></button>
                <div style="display:flex; border:1px solid var(--border); border-radius:10px; overflow:hidden;">
                    <button class="btn-icon active-lang" onclick="setLang('uz')" id="btn-uz">UZ</button>
                    <button class="btn-icon" style="border-left:1px solid var(--border); border-right:1px solid var(--border)" onclick="setLang('ru')" id="btn-ru">RU</button>
                    <button class="btn-icon" onclick="setLang('en')" id="btn-en">EN</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container main-wrapper">
        
        <!-- Sidebar -->
        <aside>
            <div class="card">
                <h3><i class="fa-solid fa-filter"></i> <span id="t-filter">Filtrlash</span></h3>
                
                <label id="t-type" style="font-size:0.85rem; color:var(--text-secondary)">Qog'oz Turi</label>
                <select id="filter-type" class="form-select" onchange="renderApp()">
                    <option value="">— Barchasi —</option>
                </select>

                <label id="t-industry" style="font-size:0.85rem; color:var(--text-secondary)">Tarmoq</label>
                <select id="filter-industry" class="form-select" onchange="renderApp()">
                    <option value="">— Barchasi —</option>
                </select>

                <label id="t-region" style="font-size:0.85rem; color:var(--text-secondary)">Hudud</label>
                <select id="filter-region" class="form-select" onchange="renderApp()">
                    <option value="">— Barchasi —</option>
                </select>

                <label id="t-issuer" style="font-size:0.85rem; color:var(--text-secondary)">Emitentni izlash</label>
                <input type="text" id="filter-issuer" class="form-input" placeholder="..." oninput="renderApp()">

                <label id="t-date" style="font-size:0.85rem; color:var(--text-secondary)">Davr (Yil_Oy)</label>
                <select id="filter-period" class="form-select" onchange="renderApp()">
                    <option value="">— Eng so'nggi —</option>
                </select>

                <button class="btn-icon" style="width:100%; border-radius:8px;" onclick="resetFilters()">
                    <i class="fa-solid fa-rotate-right"></i> <span id="t-reset">Tozalash</span>
                </button>
            </div>

            <!-- INVESTMENT CALCULATOR -->
            <div class="card">
                <h3><i class="fa-solid fa-calculator"></i> <span id="t-calc-title">Investitsiya Kalkulyatori</span></h3>
                <label style="font-size:0.85rem; color:var(--text-secondary)" id="t-calc-amount">Mablag' miqdori</label>
                <div class="input-group">
                    <input type="text" inputmode="numeric" id="calc-input" class="form-input" value="1 000 000" oninput="formatCalcInput(this)">
                    <span class="input-currency" id="calc-curr-label">UZS</span>
                </div>
                
                <label style="font-size:0.85rem; color:var(--text-secondary)" id="t-calc-select">Emitentni tanlang</label>
                <select id="calc-issuer-select" class="form-select" onchange="calculateInvestment()"></select>

                <div class="calc-box">
                    <div class="calc-row">
                        <span class="calc-label" id="t-calc-type">Qog'oz turi:</span>
                        <span class="calc-val" id="calc-type-val" style="font-size:0.85rem;">-</span>
                    </div>
                    <div class="calc-row">
                        <span class="calc-label" id="t-calc-code">Kodi:</span>
                        <span class="calc-val" id="calc-code-val" style="font-size:0.85rem;">-</span>
                    </div>
                    <div style="border-top:1px dashed var(--border); margin:8px 0;"></div>
                    <div class="calc-row">
                        <span class="calc-label" id="t-calc-nominal">Nominal narx:</span>
                        <span class="calc-val" id="calc-nominal-val">-</span>
                    </div>
                    <div class="calc-row">
                        <span class="calc-label" id="t-calc-min">Minimal narx:</span>
                        <span class="calc-val" id="calc-min-val">-</span>
                    </div>
                    <div class="calc-row">
                        <span class="calc-label" id="t-calc-price">O'rtacha narx:</span>
                        <span class="calc-val" id="calc-avg-price">-</span>
                    </div>
                    <div class="calc-row">
                        <span class="calc-label" id="t-calc-max">Maksimal narx:</span>
                        <span class="calc-val" id="calc-max-val">-</span>
                    </div>
                    
                    <div style="border-top:1px dashed var(--border); margin:10px 0;"></div>
                    
                    <div class="calc-row">
                        <span class="calc-label" id="t-calc-rating">Reyting bali:</span>
                        <span class="calc-val" id="calc-rating-score">-</span>
                    </div>
                    <div class="calc-row">
                        <span class="calc-label" id="t-calc-grade">Reyting:</span>
                        <span class="calc-val" id="calc-rating-grade">-</span>
                    </div>
                    
                    <div style="margin-top:10px; border-top:1px dashed var(--border); padding-top:10px;">
                        <span class="calc-label" style="font-weight:600;" id="t-calc-qty">Sotib olish mumkin:</span>
                        <div class="calc-profit" style="font-size:1.1rem; margin-top:5px;" id="calc-result-qty">0 dona</div>
                    </div>
                </div>
            </div>

            <div class="card promo-card">
                <div class="promo-bg"></div>
                <div style="position:relative; z-index:2;">
                    <!-- Updated Logo -->
                    <img src="https://snsratings.uz/static/media/logo.b58a119151d230b7d82af1dfaf415791.svg" class="promo-logo" alt="Logo">
                    
                    <!-- Rotating Slogan -->
                    <p id="t-slogan-text" style="font-size:0.95rem; font-weight:600; margin-top:8px; min-height: 40px; display:flex; align-items:center; justify-content:center;">
                        ...
                    </p>
                    
                    <!-- Social Links -->
                    <div class="social-links">
                        <a href="https://snsratings.uz/" target="_blank"><i class="fa-solid fa-globe"></i> Web</a>
                        <a href="https://t.me/snsratings" target="_blank"><i class="fa-brands fa-telegram"></i> Telegram</a>
                    </div>

                    <!-- Contact Info -->
                    <p id="t-contact-msg" style="font-size:0.75rem; color:#e0e7ff; margin: 15px 0 0 0; font-style:italic; border-top:1px dashed rgba(255,255,255,0.3); padding-top:10px;">
                        Batafsil ma'lumot olish uchun Reyting Agentligi hodimlariga murojaat qiling
                    </p>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main>
            <!-- KPI Cards Full Width -->
            <div class="stats-grid">
                <!-- Top Rated -->
                <div class="stat-card">
                    <div class="stat-info">
                        <p id="t-kpi-rating" style="font-size:0.85rem; color:var(--text-secondary)">Eng Yuqori Reyting</p>
                        <h3 style="margin:5px 0; color:var(--primary); font-size:1.4rem;" id="kpi-top-rating-val">0</h3>
                        <span class="change-badge" id="kpi-top-rating-name">-</span>
                    </div>
                    <div class="stat-icon" style="background: rgba(67, 97, 238, 0.1); color: var(--primary);">
                        <i class="fa-solid fa-star"></i>
                    </div>
                </div>
                
                <!-- Max Volume -->
                <div class="stat-card">
                    <div class="stat-info">
                        <p id="t-kpi-volume" style="font-size:0.85rem; color:var(--text-secondary)">Jami Savdo Hajmi (mln)</p>
                        <h3 style="margin:5px 0; color:var(--success); font-size:1.4rem;" id="kpi-volume-val">0</h3>
                        <span class="change-badge" style="background:none; padding-left:0;" id="t-kpi-volume-sub">Tanlangan davr uchun</span>
                    </div>
                    <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--success);">
                        <i class="fa-solid fa-sack-dollar"></i>
                    </div>
                </div>

                <!-- Total Deals Count -->
                <div class="stat-card">
                    <div class="stat-info">
                        <p id="t-kpi-count" style="font-size:0.85rem; color:var(--text-secondary)">Jami bitimlar soni</p>
                        <h3 style="margin:5px 0; color:var(--info); font-size:1.4rem;" id="kpi-count-val">0</h3>
                        <span class="change-badge" id="t-kpi-count-sub">Faollik ko'rsatkichi</span>
                    </div>
                    <div class="stat-icon" style="background: rgba(6, 182, 212, 0.1); color: var(--info);">
                        <i class="fa-solid fa-handshake"></i>
                    </div>
                </div>

                <!-- Max Activity -->
                <div class="stat-card">
                    <div class="stat-info">
                        <p id="t-kpi-activity" style="font-size:0.85rem; color:var(--text-secondary)">Eng Faol (Bitimlar)</p>
                        <h3 style="margin:5px 0; color:var(--orange); font-size:1.4rem;" id="kpi-activity-val">0</h3>
                        <span class="change-badge" id="kpi-activity-name">-</span>
                    </div>
                    <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--orange);">
                        <i class="fa-solid fa-bolt"></i>
                    </div>
                </div>
                
                <!-- Avg Rating -->
                <div class="stat-card">
                    <div class="stat-info">
                        <p id="t-kpi-avg" style="font-size:0.85rem; color:var(--text-secondary)">O'rtacha Reyting Bali</p>
                        <h3 style="margin:5px 0; color:var(--purple); font-size:1.4rem;" id="kpi-avg-val">0</h3>
                        <span class="change-badge" id="t-kpi-avg-sub">Umumiy ko'rsatkich</span>
                    </div>
                    <div class="stat-icon" style="background: rgba(139, 92, 246, 0.1); color: var(--purple);">
                        <i class="fa-solid fa-chart-pie"></i>
                    </div>
                </div>
            </div>

            <!-- Charts Container -->
            <div class="charts-row" id="charts-container">
                <!-- Market Trend Chart -->
                <div class="card" id="card-trend">
                    <h4 id="t-chart-trend" style="margin:0 0 15px 0;">O'rtacha Ball Dinamikasi</h4>
                    <div class="chart-box"><canvas id="chart-trend"></canvas></div>
                </div>
                <!-- Industry Doughnut Chart -->
                <div class="card" id="card-doughnut">
                    <h4 id="t-chart-industry" style="margin:0 0 15px 0;">Tarmoqlar Kesimi (Hajm bo'yicha)</h4>
                    <div class="chart-box"><canvas id="chart-doughnut"></canvas></div>
                </div>
            </div>

            <div class="card" id="table-card">
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; margin-bottom:15px;">
                    <div>
                        <h4 id="t-table-title" style="margin:0; display:inline-block;">Batafsil Jadval</h4>
                        <small id="row-count-label" style="color:var(--text-secondary); margin-left:10px; font-size:0.75rem;"></small>
                    </div>
                    <button onclick="exportTableToExcel()" class="btn-icon" style="width:auto; padding:0 15px; font-size:0.9rem;">
                        <i class="fa-solid fa-file-excel"></i> Excel
                    </button>
                </div>
                <div class="table-container">
                    <table id="rating-table"></table>
                </div>
            </div>
        </main>
    </div>

    <div class="footer">
        © 2026 Standard and Sensitive Ratings
    </div>

    <script>
        const API_URL = "https://raw.githubusercontent.com/sunattagayev-cloud/Attractiveness-rating/refs/heads/main/Attractiveness_rating_of_securities.json";
        let rawData = [];
        let currentLang = 'uz';
        let sloganInterval;
        
        const i18n = {
            uz: {
                brand: "Investitsion Tahlil", subtitle: "Qimmatli qog'ozlar jozibadorlik reytingi", source: "Manba: <a href='https://uzse.uz' target='_blank'>uzse.uz</a> va <a href='https://new.openinfo.uz/' target='_blank'>openinfo.uz</a> ma'lumotlari va Reyting Agentligi metodikasi asosida",
                filter: "Filtrlash", type: "Qog'oz Turi", industry: "Tarmoq", region: "Hudud", issuer: "Emitentni izlash", date: "Davr", all: "— Barchasi —", reset: "Tozalash",
                kpiRating: "Eng Yuqori Reyting", kpiVolume: "Jami Savdo Hajmi (mln)", kpiActivity: "Eng Faol (Bitimlar)", kpiAvg: "O'rtacha Reyting Bali", kpiCount: "Jami bitimlar soni",
                kpiSubVol: "Tanlangan davr uchun", kpiSubAvg: "Umumiy ko'rsatkich", kpiSubCount: "Faollik ko'rsatkichi",
                chartTrend: "O'rtacha Ball Dinamikasi", chartIndustry: "Tarmoqlar Kesimi (Hajm bo'yicha)", tableTitle: "Batafsil Jadval",
                thIssuer: "Emitent", thVolume: "Hajm (mln)", thFreq: "Bitimlar", thPrice: "O'rtacha Narx", thRateScore: "Ball", thGrade: "Reyting", thPeriod: "Davr",
                calcTitle: "Investitsiya Kalkulyatori", calcAmount: "Mablag' miqdori", calcSelect: "Emitentni tanlang", calcType: "Qog'oz turi:", calcCode: "Kodi:", calcPrice: "O'rtacha narx:", calcNominal: "Nominal narx:", calcMin: "Minimal narx:", calcMax: "Maksimal narx:", calcRating: "Reyting bali:", calcGrade: "Reyting:", calcQty: "Sotib olish mumkin:",
                others: "Boshqalar", units: "dona", contactMsg: "Batafsil ma'lumot olish uchun Reyting Agentligi hodimlariga murojaat qiling"
            },
            ru: {
                brand: "Инвестиционный Анализ", subtitle: "Рейтинг привлекательности ценных бумаг", source: "Источник: на основе данных <a href='https://uzse.uz' target='_blank'>uzse.uz</a>, <a href='https://new.openinfo.uz/' target='_blank'>openinfo.uz</a> и методики Рейтингового Агентства",
                filter: "Фильтр", type: "Тип бумаги", industry: "Отрасль", region: "Регион", issuer: "Поиск эмитента", date: "Период", all: "— Все —", reset: "Сброс",
                kpiRating: "Высший Рейтинг", kpiVolume: "Общий объем (млн)", kpiActivity: "Самый активный (Сделки)", kpiAvg: "Средний балл", kpiCount: "Всего сделок",
                kpiSubVol: "За выбранный период", kpiSubAvg: "Общий показатель", kpiSubCount: "Показатель активности",
                chartTrend: "Динамика Среднего Балла", chartIndustry: "По отраслям (Объем)", tableTitle: "Подробная таблица",
                thIssuer: "Эмитент", thVolume: "Объем (млн)", thFreq: "Сделки", thPrice: "Сред. цена", thRateScore: "Балл", thGrade: "Рейтинг", thPeriod: "Период",
                calcTitle: "Калькулятор Инвестиций", calcAmount: "Сумма вложений", calcSelect: "Выберите эмитента", calcType: "Тип бумаги:", calcCode: "Код:", calcPrice: "Средняя цена:", calcNominal: "Номинал:", calcMin: "Мин. цена:", calcMax: "Макс. цена:", calcRating: "Рейтинговый балл:", calcGrade: "Рейтинг:", calcQty: "Можно купить:",
                others: "Другие", units: "шт.", contactMsg: "Для получения подробной информации обратитесь к сотрудникам Рейтингового агентства"
            },
            en: {
                brand: "Investment Analysis", subtitle: "Securities Attractiveness Rating", source: "Source: based on <a href='https://uzse.uz' target='_blank'>uzse.uz</a>, <a href='https://new.openinfo.uz/' target='_blank'>openinfo.uz</a> data and Rating Agency methodology",
                filter: "Filters", type: "Security Type", industry: "Industry", region: "Region", issuer: "Search Issuer", date: "Period", all: "— All —", reset: "Reset",
                kpiRating: "Highest Rating", kpiVolume: "Total Volume (mln)", kpiActivity: "Most Active (Deals)", kpiAvg: "Avg Score", kpiCount: "Total Deals",
                kpiSubVol: "For selected period", kpiSubAvg: "General indicator", kpiSubCount: "Activity indicator",
                chartTrend: "Average Score Dynamics", chartIndustry: "Industry Split (Volume)", tableTitle: "Detailed Table",
                thIssuer: "Issuer", thVolume: "Volume (mln)", thFreq: "Deals", thPrice: "Avg Price", thRateScore: "Score", thGrade: "Grade", thPeriod: "Period",
                calcTitle: "Investment Calculator", calcAmount: "Investment Amount", calcSelect: "Select Issuer", calcType: "Type:", calcCode: "Code:", calcPrice: "Avg Price:", calcNominal: "Nominal Price:", calcMin: "Min Price:", calcMax: "Max Price:", calcRating: "Rating Score:", calcGrade: "Rating:", calcQty: "Can Buy:",
                others: "Others", units: "pcs", contactMsg: "For detailed information, please contact Rating Agency staff"
            }
        };

        const dictionary = {
            "MOLIYAVIY VA SUG'URTA FAOLIYATI": { ru: "ФИНАНСОВАЯ И СТРАХОВАЯ ДЕЯТЕЛЬНОСТЬ", en: "FINANCIAL AND INSURANCE ACTIVITIES" },
            "ISHLAB CHIQARISH SANOATI": { ru: "ОБРАБАТЫВАЮЩАЯ ПРОМЫШЛЕННОСТЬ", en: "MANUFACTURING" },
            "TRANSPORT VA SAQLASH": { ru: "ТРАНСПОРТИРОВКА И ХРАНЕНИЕ", en: "TRANSPORTATION AND STORAGE" },
            "QURILISH": { ru: "СТРОИТЕЛЬСТВО", en: "CONSTRUCTION" },
            "KONCHILIK VA KARERCHILIK": { ru: "ГОРНОДОБЫВАЮЩАЯ ПРОМЫШЛЕННОСТЬ", en: "MINING AND QUARRYING" },
            "KO'CHMAS MULK BITIMLARI": { ru: "ОПЕРАЦИИ С НЕДВИЖИМЫМ ИМУЩЕСТВОМ", en: "REAL ESTATE ACTIVITIES" },
            "QISHLOQ XO'JALIGI, O'RMON XO'JALIGI VA BALIQCHILIK": { ru: "СЕЛЬСКОЕ, ЛЕСНОЕ И РЫБНОЕ ХОЗЯЙСТВО", en: "AGRICULTURE, FORESTRY AND FISHING" },
            "KASBIY, ILMIY VA TEXNIK FAOLIYAT": { ru: "ПРОФЕССИОНАЛЬНАЯ, НАУЧНАЯ И ТЕХНИЧЕСКАЯ ДЕЯТЕЛЬНОСТЬ", en: "PROFESSIONAL, SCIENTIFIC AND TECHNICAL ACTIVITIES" },
            "AXBOROT VA KOMMUNIKATSIYA": { ru: "ИНФОРМАЦИЯ И СВЯЗЬ", en: "INFORMATION AND COMMUNICATION" },
            "ULGURJI VA CHAKANA SAVDO; AVTOMOBIL VA MOTOTSIKLLARNI TA'MIRLASH": { ru: "ОПТОВАЯ И РОЗНИЧНАЯ ТОРГОВЛЯ", en: "WHOLESALE AND RETAIL TRADE" },
            "BOSHQARUV VA QO'LLAB-QUVVATLASH XIZMATLARI FAOLIYATI": { ru: "ДЕЯТЕЛЬНОСТЬ ПО АДМИНИСТРИРОВАНИЮ", en: "ADMINISTRATIVE AND SUPPORT SERVICE ACTIVITIES" },
            "BOSHQALAR": { ru: "ДРУГИЕ", en: "OTHERS" },
            "Toshkent shahri": { ru: "г. Ташкент", en: "Tashkent city" },
            "Toshkent viloyati": { ru: "Ташкентская область", en: "Tashkent region" },
            "Andijon viloyati": { ru: "Андижанская область", en: "Andijan region" },
            "Farg'ona viloyati": { ru: "Ферганская область", en: "Fergana region" },
            "Buxoro viloyati": { ru: "Бухарская область", en: "Bukhara region" },
            "Samarqand viloyati": { ru: "Самаркандская область", en: "Samarkand region" },
            "Navoiy viloyati": { ru: "Навоийская область", en: "Navoi region" },
            "Qashqadaryo viloyati": { ru: "Кашкадарьинская область", en: "Kashkadarya region" },
            "Sirdaryo viloyati": { ru: "Сырдарьинская область", en: "Syrdarya region" },
            "Xorazm viloyati": { ru: "Хорезмская область", en: "Khorezm region" },
            "Namangan viloyati": { ru: "Наманганская область", en: "Namangan region" },
            "Qoraqalpog'iston Respublikasi": { ru: "Республика Каракалпакстан", en: "Republic of Karakalpakstan" },
            "Oddiy aksiya": { ru: "Простая акция", en: "Common share" },
            "Imtiyozli aksiya": { ru: "Привилегированная акция", en: "Preferred share" },
            "Korporativ obligatsiya": { ru: "Корпоративная облигация", en: "Corporate bond" }
        };

        const slogans = {
            uz: ["Shaxsiy kapitalingizni ishonchli reytinglar asosida o'stiring", "Har bir raqam ortida aniq tahlil yotadi", "Investitsiya - kelajak poydevori", "Bozor tendensiyalarini biz bilan kuzating", "Mablag'ingizni to'g'ri yo'naltiring", "Qimmatli qog'ozlar bozorining eng so'nggi ma'lumotlari"],
            ru: ["Увеличивайте свой капитал на основе надежных рейтингов", "За каждой цифрой стоит точный анализ", "Инвестиции - это фундамент будущего", "Следите за рыночными тенденциями вместе с нами", "Направляйте свои средства правильно", "Последние данные фондового рынка"],
            en: ["Grow your capital based on reliable ratings", "Accurate analysis lies behind every number", "Investment is the foundation of the future", "Track market trends with us", "Direct your funds correctly", "Latest data from the securities market"]
        };

        let chartTrend = null;
        let chartDoughnut = null;
        let sortDir = -1;
        const fmtMoney = (n) => n ? Number(n).toLocaleString('ru-RU') : '0';

        function translateVal(val) {
            if (currentLang === 'uz') return val;
            if (dictionary[val] && dictionary[val][currentLang]) return dictionary[val][currentLang];
            return val;
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
            }
            await fetchData();
            startSloganRotator();
        });

        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Network error");
                const text = await response.text();
                try { rawData = JSON.parse(text); } catch(e) { rawData = []; }
                
                rawData.forEach(d => {
                    d['Reyting bali'] = parseFloat(d['Reyting bali']) || 0;
                    d['Bitimlar hajmi, mln so\'mda'] = parseFloat(d['Bitimlar hajmi, mln so\'mda']) || 0;
                    d['Bitimlar chastotasi'] = parseInt(d['Bitimlar chastotasi']) || 0;
                    d['Savdo narxi - o\'rtacha'] = parseFloat(d['Savdo narxi - o\'rtacha']) || 0;
                    d['Savdo narxi - min'] = parseFloat(d['Savdo narxi - min']) || 0;
                    d['Savdo narxi - max'] = parseFloat(d['Savdo narxi - max']) || 0;
                    d['Nominal narx'] = parseFloat(d['Nominal narx']) || 0;
                });

                document.getElementById('loader').style.display = 'none';
                initFilterOptions();
                renderApp();
            } catch (error) {
                console.error(error);
                document.getElementById('loader').innerHTML = `<div style="text-align:center; color:var(--danger)">Xatolik yuz berdi. <br><button onclick="location.reload()">Qayta urinish</button></div>`;
            }
        }

        function toggleTheme() { document.body.classList.toggle('dark-mode'); renderApp(); }
        function setLang(l) {
            currentLang = l;
            ['uz','ru','en'].forEach(x => document.getElementById('btn-'+x).classList.remove('active-lang'));
            document.getElementById('btn-'+l).classList.add('active-lang');
            updateLangTexts();
            initFilterOptions(); 
            renderApp();
            startSloganRotator();
        }

        function updateLangTexts() {
            const t = i18n[currentLang];
            const mapping = {
                't-brand': t.brand, 't-subtitle': t.subtitle, 't-source': t.source, 't-filter': t.filter,
                't-type': t.type, 't-industry': t.industry, 't-region': t.region, 't-issuer': t.issuer, 't-date': t.date,
                't-reset': t.reset, 't-kpi-rating': t.kpiRating, 't-kpi-volume': t.kpiVolume, 't-kpi-activity': t.kpiActivity,
                't-kpi-avg': t.kpiAvg, 't-kpi-count': t.kpiCount,
                't-kpi-volume-sub': t.kpiSubVol, 't-kpi-avg-sub': t.kpiSubAvg, 't-kpi-count-sub': t.kpiSubCount,
                't-chart-trend': t.chartTrend, 't-chart-industry': t.chartIndustry, 't-table-title': t.tableTitle,
                't-calc-title': t.calcTitle, 't-calc-amount': t.calcAmount, 't-calc-select': t.calcSelect, 't-calc-type': t.calcType,
                't-calc-code':t.calcCode, 't-calc-price': t.calcPrice, 't-calc-nominal': t.calcNominal, 't-calc-min':t.calcMin, 't-calc-max':t.calcMax, 
                't-calc-rating': t.calcRating, 't-calc-grade': t.calcGrade, 't-calc-qty': t.calcQty,
                't-contact-msg': t.contactMsg 
            };
            
            for (const [id, text] of Object.entries(mapping)) {
                const el = document.getElementById(id);
                if(el) el.innerHTML = text;
            }
        }

        function startSloganRotator() {
            if(sloganInterval) clearInterval(sloganInterval);
            const el = document.getElementById('t-slogan-text');
            const list = slogans[currentLang];
            let idx = 0;
            
            const rotate = () => {
                el.classList.remove('slogan-animate');
                void el.offsetWidth; 
                el.innerText = list[idx];
                el.classList.add('slogan-animate');
                idx = (idx + 1) % list.length;
            };
            rotate(); 
            sloganInterval = setInterval(rotate, 4000);
        }

        function initFilterOptions() {
            const types = [...new Set(rawData.map(d => d['Qimmatbaho qog\'oz turi']))].sort();
            const industries = [...new Set(rawData.map(d => d['Tarmoq']))].sort((a,b) => {
                const isA = a.toUpperCase().includes('BOSHQALAR');
                const isB = b.toUpperCase().includes('BOSHQALAR');
                if (isA && !isB) return 1;
                if (!isA && isB) return -1;
                return a.localeCompare(b);
            });
            const regions = [...new Set(rawData.map(d => d['Xudud']))].sort();
            const periods = [...new Set(rawData.map(d => d['Davr']))].sort().reverse();

            const savedType = document.getElementById('filter-type').value;
            const savedInd = document.getElementById('filter-industry').value;
            const savedReg = document.getElementById('filter-region').value;
            const savedPer = document.getElementById('filter-period').value;

            const fillSelect = (id, arr, savedVal) => {
                const sel = document.getElementById(id);
                sel.innerHTML = `<option value="">${i18n[currentLang].all}</option>`;
                arr.forEach(x => {
                    const translated = translateVal(x);
                    const opt = new Option(translated, x);
                    if(x === savedVal) opt.selected = true;
                    sel.add(opt);
                });
            };

            const fillPeriod = (id, arr, savedVal) => {
                const sel = document.getElementById(id);
                sel.innerHTML = `<option value="">${i18n[currentLang].all}</option>`;
                arr.forEach(x => {
                    const opt = new Option(x, x);
                    if(x === savedVal) opt.selected = true;
                    sel.add(opt);
                });
                if(!savedVal && arr.length > 0) sel.value = arr[0];
            };

            fillSelect('filter-type', types, savedType);
            fillSelect('filter-industry', industries, savedInd);
            fillSelect('filter-region', regions, savedReg);
            fillPeriod('filter-period', periods, savedPer);
        }

        function resetFilters() {
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-industry').value = '';
            document.getElementById('filter-region').value = '';
            document.getElementById('filter-issuer').value = '';
            const periods = [...new Set(rawData.map(d => d['Davr']))].sort().reverse();
            if(periods.length) document.getElementById('filter-period').value = periods[0];
            renderApp();
        }

        function getFilteredData() {
            const type = document.getElementById('filter-type').value;
            const industry = document.getElementById('filter-industry').value;
            const region = document.getElementById('filter-region').value;
            const issuer = document.getElementById('filter-issuer').value.toLowerCase();
            const period = document.getElementById('filter-period').value;

            return rawData.filter(d => {
                return (!type || d['Qimmatbaho qog\'oz turi'] === type) &&
                       (!industry || d['Tarmoq'] === industry) &&
                       (!region || d['Xudud'] === region) &&
                       (!issuer || d['Emitent nomi'].toLowerCase().includes(issuer)) &&
                       (!period || d['Davr'] === period);
            });
        }

        function renderApp() {
            const data = getFilteredData();
            calculateKPIs(data);
            renderCharts(data);
            renderTable(data);
            updateCalculatorOptions(data);
            document.getElementById('row-count-label').innerText = `(${data.length})`;
        }

        function calculateKPIs(data) {
            if(data.length === 0) { 
                ['kpi-top-rating-val','kpi-volume-val','kpi-activity-val','kpi-avg-val','kpi-count-val'].forEach(id=>document.getElementById(id).innerText='0');
                return; 
            }

            let maxScore = -1, maxScoreIssuer = '-';
            let totalVolume = 0;
            let maxFreq = -1, maxFreqIssuer = '-';
            let totalScore = 0;
            let totalDeals = 0;

            data.forEach(d => {
                if(d['Reyting bali'] > maxScore) { maxScore = d['Reyting bali']; maxScoreIssuer = d['Emitent nomi']; }
                totalVolume += d['Bitimlar hajmi, mln so\'mda'];
                if(d['Bitimlar chastotasi'] > maxFreq) { maxFreq = d['Bitimlar chastotasi']; maxFreqIssuer = d['Emitent nomi']; }
                totalScore += d['Reyting bali'];
                totalDeals += d['Bitimlar chastotasi'];
            });

            const avgScore = totalScore / data.length;
            const shorten = (s) => s.length > 20 ? s.substring(0, 18)+'...' : s;

            document.getElementById('kpi-top-rating-val').innerText = maxScore.toFixed(2);
            document.getElementById('kpi-top-rating-name').innerText = maxScoreIssuer; 
            document.getElementById('kpi-volume-val').innerText = Number(totalVolume.toFixed(1)).toLocaleString('ru-RU');
            document.getElementById('kpi-activity-val').innerText = fmtMoney(maxFreq);
            document.getElementById('kpi-activity-name').innerText = shorten(maxFreqIssuer);
            document.getElementById('kpi-avg-val').innerText = avgScore.toFixed(2);
            document.getElementById('kpi-count-val').innerText = fmtMoney(totalDeals);
        }

        function renderCharts(currentData) {
            const isDark = document.body.classList.contains('dark-mode');
            const colorTxt = isDark ? '#ccc' : '#555';

            // Smart Toggle Logic
            const industryFilter = document.getElementById('filter-industry').value;
            const chartsContainer = document.getElementById('charts-container');
            const cardDoughnut = document.getElementById('card-doughnut');

            if (industryFilter) {
                cardDoughnut.style.display = 'none';
                chartsContainer.style.gridTemplateColumns = '1fr';
            } else {
                cardDoughnut.style.display = 'block';
                chartsContainer.style.gridTemplateColumns = ''; 
            }

            // 1. Market Avg Score Trend
            const type = document.getElementById('filter-type').value;
            const industry = document.getElementById('filter-industry').value;
            const region = document.getElementById('filter-region').value;
            const issuer = document.getElementById('filter-issuer').value.toLowerCase();

            const trendData = rawData.filter(d => {
                return (!type || d['Qimmatbaho qog\'oz turi'] === type) &&
                       (!industry || d['Tarmoq'] === industry) &&
                       (!region || d['Xudud'] === region) &&
                       (!issuer || d['Emitent nomi'].toLowerCase().includes(issuer));
            });

            const periodGroups = {};
            trendData.forEach(d => {
                if(!periodGroups[d['Davr']]) periodGroups[d['Davr']] = {sum:0, count:0};
                periodGroups[d['Davr']].sum += d['Reyting bali'];
                periodGroups[d['Davr']].count += 1;
            });

            const sortedPeriods = Object.keys(periodGroups).sort();
            const avgScores = sortedPeriods.map(p => (periodGroups[p].sum / periodGroups[p].count).toFixed(2));

            if(chartTrend) chartTrend.destroy();
            const ctxTrend = document.getElementById('chart-trend').getContext('2d');
            chartTrend = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: sortedPeriods,
                    datasets: [{
                        label: i18n[currentLang].kpiAvg,
                        data: avgScores,
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: {display:false}, tooltip: {mode: 'index', intersect: false} },
                    scales: { x: {ticks: {color: colorTxt}}, y: {ticks: {color: colorTxt}} }
                }
            });

            // 2. Industry Doughnut
            if (!industryFilter) {
                if(chartDoughnut) chartDoughnut.destroy();
                const industryMap = {};
                currentData.forEach(d => {
                    const key = translateVal(d['Tarmoq']);
                    if(!industryMap[key]) industryMap[key] = 0;
                    industryMap[key] += d['Bitimlar hajmi, mln so\'mda'];
                });
                
                const sortedInd = Object.entries(industryMap).sort((a,b)=>b[1]-a[1]);
                let chartLabels = [], chartValues = [];
                const palette = ['#4361ee', '#7209b7', '#f72585', '#06b6d4', '#f59e0b', '#94a3b8'];
                
                if(sortedInd.length > 6) {
                    sortedInd.slice(0, 5).forEach(x => {chartLabels.push(x[0]); chartValues.push(x[1]);});
                    const others = sortedInd.slice(5).reduce((acc, curr)=>acc+curr[1], 0);
                    chartLabels.push(i18n[currentLang].others); chartValues.push(others);
                } else {
                    sortedInd.forEach(x => {chartLabels.push(x[0]); chartValues.push(x[1]);});
                }

                const ctxDoughnut = document.getElementById('chart-doughnut').getContext('2d');
                chartDoughnut = new Chart(ctxDoughnut, {
                    type: 'doughnut',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            data: chartValues,
                            backgroundColor: palette.slice(0, chartLabels.length),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: {position: 'right', labels:{color:colorTxt, boxWidth:12, font:{size:10}}} },
                        cutout: '60%'
                    }
                });
            }
        }

        function getRatingColorClass(score) {
            if(score >= 80) return 'rating-green'; 
            if(score >= 60) return 'rating-blue';  
            if(score >= 40) return 'rating-yellow';
            return 'rating-red'; 
        }

        function getScoreBadgeColor(score) {
            if(score >= 80) return '#10b981';
            if(score >= 60) return '#4361ee';
            if(score >= 40) return '#f59e0b';
            return '#ef476f';
        }

        function renderTable(data) {
            const table = document.getElementById('rating-table');
            const t = i18n[currentLang];
            
            let html = `<thead><tr>
                <th onclick="sortTable('Emitent nomi')">${t.thIssuer} <i class="fa-solid fa-sort"></i></th>
                <th onclick="sortTable('Bitimlar hajmi, mln so\\'mda')">${t.thVolume} <i class="fa-solid fa-sort"></i></th>
                <th onclick="sortTable('Bitimlar chastotasi')">${t.thFreq} <i class="fa-solid fa-sort"></i></th>
                <th onclick="sortTable('Savdo narxi - o\\'rtacha')">${t.thPrice} <i class="fa-solid fa-sort"></i></th>
                <th onclick="sortTable('Reyting bali')">${t.thRateScore} <i class="fa-solid fa-sort"></i></th>
                <th onclick="sortTable('Reyting')">${t.thGrade} <i class="fa-solid fa-sort"></i></th>
                <th onclick="sortTable('Davr')">${t.thPeriod} <i class="fa-solid fa-sort"></i></th>
            </tr></thead><tbody>`;

            data.sort((a,b) => b['Reyting bali'] - a['Reyting bali']);

            data.forEach(row => {
                const grade = row['Reyting (uz)'] || row['Reyting'];
                const score = row['Reyting bali'];
                const gradeClass = getRatingColorClass(score);
                const scoreColor = getScoreBadgeColor(score);
                const typeTrans = translateVal(row['Qimmatbaho qog\'oz turi']);

                html += `<tr>
                    <td style="text-align:left; font-weight:500;">
                        ${row['Emitent nomi']} <br> 
                        <span style="font-size:0.75em; color:var(--text-secondary); opacity:0.8;">${row['Qimmatli qog\'oz kodi']} - ${typeTrans}</span>
                    </td>
                    <td>${fmtMoney(row['Bitimlar hajmi, mln so\'mda'])}</td>
                    <td>${row['Bitimlar chastotasi']}</td>
                    <td>${fmtMoney(row['Savdo narxi - o\'rtacha'])}</td>
                    <td><span class="score-badge" style="background:${scoreColor}">${score.toFixed(2)}</span></td>
                    <td class="${gradeClass}">${grade}</td>
                    <td style="color:var(--text-secondary);">${row['Davr']}</td>
                </tr>`;
            });
            html += '</tbody>';
            table.innerHTML = html;
            table.dataset.rows = JSON.stringify(data);
        }

        window.sortTable = function(key) {
            sortDir *= -1;
            const table = document.getElementById('rating-table');
            const data = JSON.parse(table.dataset.rows);
            data.sort((a,b) => {
                let va = a[key], vb = b[key];
                if(typeof va === 'string') return sortDir * va.localeCompare(vb);
                return sortDir * (va - vb);
            });
            
            const t = i18n[currentLang];
            let newHtml = `<thead><tr>
                <th onclick="sortTable('Emitent nomi')">${t.thIssuer} <i class="fa-solid fa-sort"></i></th>
                <th onclick="sortTable('Bitimlar hajmi, mln so\\'mda')">${t.thVolume} <i class="fa-solid fa-sort"></i></th>
                <th onclick="sortTable('Bitimlar chastotasi')">${t.thFreq} <i class="fa-solid fa-sort"></i></th>
                <th onclick="sortTable('Savdo narxi - o\\'rtacha')">${t.thPrice} <i class="fa-solid fa-sort"></i></th>
                <th onclick="sortTable('Reyting bali')">${t.thRateScore} <i class="fa-solid fa-sort"></i></th>
                <th onclick="sortTable('Reyting')">${t.thGrade} <i class="fa-solid fa-sort"></i></th>
                <th onclick="sortTable('Davr')">${t.thPeriod} <i class="fa-solid fa-sort"></i></th>
            </tr></thead><tbody>`;
            
            data.forEach(row => {
                const grade = row['Reyting (uz)'] || row['Reyting'];
                const score = row['Reyting bali'];
                const gradeClass = getRatingColorClass(score);
                const scoreColor = getScoreBadgeColor(score);
                const typeTrans = translateVal(row['Qimmatbaho qog\'oz turi']);

                newHtml += `<tr>
                    <td style="text-align:left; font-weight:500;">
                        ${row['Emitent nomi']} <br> 
                        <span style="font-size:0.75em; color:var(--text-secondary); opacity:0.8;">${row['Qimmatli qog\'oz kodi']} - ${typeTrans}</span>
                    </td>
                    <td>${fmtMoney(row['Bitimlar hajmi, mln so\'mda'])}</td>
                    <td>${row['Bitimlar chastotasi']}</td>
                    <td>${fmtMoney(row['Savdo narxi - o\'rtacha'])}</td>
                    <td><span class="score-badge" style="background:${scoreColor}">${score.toFixed(2)}</span></td>
                    <td class="${gradeClass}">${grade}</td>
                    <td style="color:var(--text-secondary);">${row['Davr']}</td>
                </tr>`;
            });
            newHtml += '</tbody>';
            table.innerHTML = newHtml;
            table.dataset.rows = JSON.stringify(data);
        }

        // --- CALCULATOR LOGIC ---
        function updateCalculatorOptions(data) {
            const select = document.getElementById('calc-issuer-select');
            select.innerHTML = '';
            const sorted = [...data].sort((a,b) => b['Reyting bali'] - a['Reyting bali']);
            sorted.forEach((d, index) => {
                const opt = new Option(d['Emitent nomi'], index);
                select.add(opt);
            });
            calculateInvestment();
        }

        function formatCalcInput(el) {
            let raw = el.value.replace(/[^0-9]/g, ''); 
            if(!raw) { el.value = ''; return; }
            el.value = Number(raw).toLocaleString('ru-RU').replace(/,/g, ' '); 
            calculateInvestment();
        }

        function calculateInvestment() {
            const amountStr = document.getElementById('calc-input').value.replace(/\s/g, '');
            const amount = parseFloat(amountStr) || 0;
            const select = document.getElementById('calc-issuer-select');
            
            if (select.selectedIndex === -1) {
                document.getElementById('calc-avg-price').innerText = "-";
                document.getElementById('calc-nominal-val').innerText = "-";
                document.getElementById('calc-min-val').innerText = "-";
                document.getElementById('calc-max-val').innerText = "-";
                document.getElementById('calc-rating-score').innerText = "-";
                document.getElementById('calc-rating-grade').innerText = "-";
                document.getElementById('calc-result-qty').innerText = "-";
                document.getElementById('calc-type-val').innerText = "-";
                document.getElementById('calc-code-val').innerText = "-";
                return;
            }
            
            const currentTableData = JSON.parse(document.getElementById('rating-table').dataset.rows || "[]");
            const selectedItem = currentTableData[select.value]; 

            if(selectedItem) {
                const price = selectedItem['Savdo narxi - o\'rtacha'];
                const nominal = selectedItem['Nominal narx'];
                const minP = selectedItem['Savdo narxi - min'];
                const maxP = selectedItem['Savdo narxi - max'];
                const score = selectedItem['Reyting bali'];
                const grade = selectedItem['Reyting (uz)'] || selectedItem['Reyting'];
                const type = translateVal(selectedItem['Qimmatbaho qog\'oz turi']);
                const code = selectedItem['Qimmatli qog\'oz kodi'];

                document.getElementById('calc-type-val').innerText = type;
                document.getElementById('calc-code-val').innerText = code;
                document.getElementById('calc-avg-price').innerText = fmtMoney(price) + " UZS";
                document.getElementById('calc-nominal-val').innerText = fmtMoney(nominal) + " UZS";
                document.getElementById('calc-min-val').innerText = fmtMoney(minP) + " UZS";
                document.getElementById('calc-max-val').innerText = fmtMoney(maxP) + " UZS";
                document.getElementById('calc-rating-score').innerText = score.toFixed(2);
                document.getElementById('calc-rating-grade').innerText = grade;
                
                if (price > 0) {
                    const qty = Math.floor(amount / price);
                    document.getElementById('calc-result-qty').innerText = fmtMoney(qty) + " " + i18n[currentLang].units;
                } else {
                    document.getElementById('calc-result-qty').innerText = "0";
                }
            }
        }

        function exportTableToExcel() {
            const table = document.getElementById('rating-table');
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, `Securities_Rating_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
    </script>
</body>
</html>
